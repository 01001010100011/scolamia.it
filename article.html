<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Articolo - ScolaMia.it</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { accent: "#0c7ff2", paper: "#f4f3ee", ink: "#101010" },
          fontFamily: { display: ["Bebas Neue", "sans-serif"], body: ["IBM Plex Sans", "sans-serif"] },
          boxShadow: { brutal: "4px 4px 0 0 #000" }
        }
      }
    };
  </script>
  <style>
    body { font-family: "IBM Plex Sans", sans-serif; background: #f4f3ee; }
    .headline { font-family: "Bebas Neue", sans-serif; letter-spacing: .04em; }
  </style>
</head>
<body class="text-ink">
  <main class="max-w-4xl mx-auto px-4 md:px-8 py-10">
    <a href="index.html" class="text-xs font-bold uppercase underline">Torna alla home</a>
    <article id="articleContainer" class="mt-4 border-4 border-black bg-white p-6 md:p-10 shadow-brutal"></article>
  </main>

  <script>
    const STORAGE_KEY = "blogDeScuolaArticles";
    const SESSION_KEY = "blogDeScuolaAdmin";

    function getArticles() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      } catch {
        return [];
      }
    }

    function escapeHtml(value) {
      return value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function render() {
      const id = new URLSearchParams(window.location.search).get("id");
      const article = getArticles().find((item) => item.id === id);
      const container = document.getElementById("articleContainer");

      if (!article) {
        container.innerHTML = '<p class="text-lg font-semibold">Articolo non trovato.</p>';
        return;
      }

      const isAdmin = sessionStorage.getItem(SESSION_KEY) === "1";
      if (!article.published && !isAdmin) {
        container.innerHTML = '<p class="text-lg font-semibold">Articolo non disponibile.</p>';
        return;
      }

      const safeText = escapeHtml(article.content).replaceAll("\n", "<br>");
      const attachments = Array.isArray(article.attachments) ? article.attachments : [];
      container.innerHTML = `
        <p class="text-xs uppercase font-bold text-accent">${escapeHtml(article.category)}</p>
        <h1 class="headline text-6xl mt-2">${escapeHtml(article.title)}</h1>
        <p class="mt-4 text-sm">${escapeHtml(article.excerpt)}</p>
        ${article.imageDataUrl ? `<div class="mt-6 border-2 border-black aspect-[16/9] overflow-hidden"><img src="${article.imageDataUrl}" alt="${escapeHtml(article.title)}" class="w-full h-full object-cover" /></div>` : ""}
        <div class="mt-8 pt-6 border-t-2 border-black prose max-w-none prose-p:leading-7">
          <p>${safeText}</p>
        </div>
        ${attachments.length ? `
          <section class="mt-8 pt-6 border-t-2 border-black">
            <h2 class="headline text-4xl">Allegati</h2>
            <div class="mt-3 space-y-2">
              ${attachments.map((item) => `
                <a href="${item.dataUrl}" download="${escapeHtml(item.name || "allegato")}" class="block border-2 border-black p-3 font-semibold underline">
                  ${escapeHtml(item.name || "Allegato")}
                </a>
              `).join("")}
            </div>
          </section>
        ` : ""}
      `;
    }

    render();
  </script>
</body>
</html>
